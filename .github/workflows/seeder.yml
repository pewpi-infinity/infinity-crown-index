name: Repo Seeder (Legacy)

on:
  # Disabled - replaced by repo-seeder.yml which runs hourly
  # schedule:
  #   - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  seed:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Seed Empty Repos
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 <<'EOPY'
import requests
import json
import base64
import os
import sys
import time

USER = "pewpi-infinity"
TOKEN = os.environ.get("GITHUB_TOKEN", "")
if not TOKEN:
    print("No GITHUB_TOKEN. Exiting.")
    sys.exit(1)

HEADERS = {"Authorization": f"token {TOKEN}"}

repos = []
for page in range(1, 15):
    r = requests.get(
        f"https://api.github.com/users/{USER}/repos?per_page=100&page={page}",
        headers=HEADERS, timeout=10
    )
    if r.status_code != 200:
        break
    batch = r.json()
    if not batch:
        break
    repos.extend(batch)

seeded = 0
for repo in repos[:20]:
    name = repo['name']

    check = requests.get(
        f"https://api.github.com/repos/{USER}/{name}/readme",
        headers=HEADERS, timeout=10
    )

    if check.status_code == 404:
        print(f"Seeding {name}...", end=" ", flush=True)

        content = f"""# {name}

Part of Infinity Realm - Building autonomously

## Status
- Connected to Crown Index
- Ready for automation
- Part of 1011+ repo network
"""

        payload = {
            "message": "Seeded by Infinity System",
            "content": base64.b64encode(content.encode()).decode()
        }

        result = requests.put(
            f"https://api.github.com/repos/{USER}/{name}/contents/README.md",
            json=payload, headers=HEADERS, timeout=10
        )

        if result.status_code in [200, 201]:
            seeded += 1
            print("OK")
        elif result.status_code == 401:
            print("AUTH FAILED")
            break
        elif result.status_code == 403:
            wait = int(result.headers.get("Retry-After", 60))
            print(f"Rate limited {wait}s")
            time.sleep(wait)
        else:
            print(f"HTTP {result.status_code}")

        time.sleep(1)

print(f"Seeded {seeded} repos")
EOPY
