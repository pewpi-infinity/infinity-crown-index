name: Repo Seeder (Continuous)

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  seed-repos:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Seed Empty Repos
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 <<'EOPY'
import requests
import json
import base64
import os
import sys
import time
from datetime import datetime, timezone

USER = "pewpi-infinity"
TOKEN = os.environ.get("GITHUB_TOKEN", "")
if not TOKEN:
    print("No GITHUB_TOKEN set. Exiting.")
    sys.exit(1)

HEADERS = {"Authorization": f"token {TOKEN}"}

try:
    with open("api/dictionary.json") as f:
        data = json.load(f)
except (FileNotFoundError, json.JSONDecodeError):
    print("No dictionary.json found. Run dictionary-builder first.")
    sys.exit(0)

empty_repos = data.get("empty_repos", [])[:10]
seeded = 0

for repo_info in empty_repos:
    repo_name = repo_info['name']
    print(f"Seeding {repo_name}...", end=" ", flush=True)

    readme_content = f"""# {repo_name}

**Part of the Infinity Realm**

This repository is being built autonomously by C13B0 systems.

## Status
- Seeded: {datetime.now(timezone.utc).isoformat()}
- Growing: Content will populate based on realm dictionary
- Connected: Part of 1011+ repo ecosystem

## Actions
Click emoji buttons in Crown Index to build this repo.
"""

    url = f"https://api.github.com/repos/{USER}/{repo_name}/contents/README.md"
    content_b64 = base64.b64encode(readme_content.encode()).decode()

    payload = {
        "message": "Seeded by C13B0",
        "content": content_b64
    }

    try:
        check = requests.get(url, headers=HEADERS, timeout=10)
        if check.status_code == 200:
            payload["sha"] = check.json()["sha"]

        result = requests.put(url, json=payload, headers=HEADERS, timeout=10)
        if result.status_code in [200, 201]:
            print("OK")
            seeded += 1
        elif result.status_code == 401:
            print("AUTH FAILED")
            break
        elif result.status_code == 403:
            wait = int(result.headers.get("Retry-After", 60))
            print(f"Rate limited {wait}s")
            time.sleep(wait)
        else:
            print(f"HTTP {result.status_code}")
    except requests.exceptions.RequestException as e:
        print(f"ERR: {e}")

    time.sleep(1)

print(f"Seeded {seeded}/{len(empty_repos)} repos")
EOPY

      - name: Commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add api/ || true
          git diff --cached --quiet || git commit -m "Repo seeder cycle"
          git push || true
